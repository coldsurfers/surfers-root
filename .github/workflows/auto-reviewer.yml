name: Assign Team Members as Reviewers (via curl)

on:
  pull_request:
    types: [opened, ready_for_review]

jobs:
  assign-reviewers:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Get team members and assign reviewers
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ORG: coldsurfers
          TEAM_SLUG: developers
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          set -e

          echo "ðŸ” Getting team members from @${ORG}/${TEAM_SLUG}..."
          reviewers=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" \
            "https://api.github.com/orgs/${ORG}/teams/${TEAM_SLUG}/members" | \
            jq -r '.[].login' | jq -R -s -c 'split("\n") | map(select(length > 0))')

          echo "ðŸ‘¥ Reviewers: $reviewers"

          owner=$(echo $REPO | cut -d'/' -f1)
          repo=$(echo $REPO | cut -d'/' -f2)

          echo "ðŸš€ Assigning to PR #${PR_NUMBER} in ${owner}/${repo}..."

          curl -s -X POST \
            -H "Authorization: token ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${owner}/${repo}/pulls/${PR_NUMBER}/requested_reviewers \
            -d "{\"reviewers\": $reviewers}"
